<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Tracker</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <header>
        <h1>Production Tracker</h1>
    </header>

    <main>
        <section id="loginSection">
            <h2>Login</h2>
            <form id="loginForm">
                <input type="text" id="username" placeholder="Username" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit">Login</button>
            </form>
        </section>

        <section id="addLogSection" style="display: none;">
            <h2>Add Production Log</h2>
            <form id="productionForm">
                <div class="form-group">
                    <label for="productSelect">Product:</label>
                    <select id="productSelect" required>
                        <option value="">Select a product</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="quantity">Quantity:</label>
                    <input type="number" id="quantity" required>
                    <span id="unitType"></span>
                </div>
                <div class="form-group">
                    <label for="manufacturingUnitSelect">Manufacturing Unit:</label>
                    <select id="manufacturingUnitSelect" required>
                        <option value="">Select a manufacturing unit</option>
                    </select>
                </div>
                <button type="submit">Add Production Log</button>
            </form>
        </section>

        <section id="viewLogsSection" style="display: none;">
            <h2>View Production Logs</h2>
            <div class="date-filter">
                <label for="startDate">Start Date:</label>
                <input type="date" id="startDate">
                <label for="endDate">End Date:</label>
                <input type="date" id="endDate">
                <button id="filterButton">Filter</button>
            </div>
            <table id="productionTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Product</th>
                        <th>Quantity</th>
                        <th>Manufacturing Unit</th>
                        <th>Updation Reason</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="productionData"></tbody>
            </table>
        </section>
    </main>

    <script>
        let token = '';
        let products = [];
        let manufacturingUnits = [];

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const response = await fetch('/api/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, password }),
            });

            const data = await response.json();
            if (data.success) {
                token = data.token;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('addLogSection').style.display = 'block';
                document.getElementById('viewLogsSection').style.display = 'block';
                fetchProducts();
                fetchManufacturingUnits();
                fetchProductionData();
            } else {
                alert('Login failed. Please try again.');
            }
        });

        async function fetchProducts() {
            const response = await fetch('/api/products', {
                headers: {
                    'Authorization': token
                }
            });
            products = await response.json();
            const productSelect = document.getElementById('productSelect');
            productSelect.innerHTML = '<option value="">Select a product</option>';
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = product.name;
                productSelect.appendChild(option);
            });
        }

        async function fetchManufacturingUnits() {
            const response = await fetch('/api/manufacturing-units', {
                headers: {
                    'Authorization': token
                }
            });
            manufacturingUnits = await response.json();
            const manufacturingUnitSelect = document.getElementById('manufacturingUnitSelect');
            manufacturingUnitSelect.innerHTML = '<option value="">Select a manufacturing unit</option>';
            manufacturingUnits.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit.id;
                option.textContent = unit.name;
                manufacturingUnitSelect.appendChild(option);
            });
        }

        document.getElementById('productSelect').addEventListener('change', function () {
            const selectedProduct = products.find(p => p.id == this.value);
            if (selectedProduct) {
                document.getElementById('unitType').textContent = selectedProduct.unit;
            } else {
                document.getElementById('unitType').textContent = '';
            }
        });

        document.getElementById('productionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const productId = document.getElementById('productSelect').value;
            const quantityManufactured = document.getElementById('quantity').value;
            const manufacturedByUnitId = document.getElementById('manufacturingUnitSelect').value;

            const response = await fetch('/api/production', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token
                },
                body: JSON.stringify({ productId, quantityManufactured, manufacturedByUnitId }),
            });

            if (response.ok) {
                fetchProductionData();
                document.getElementById('productionForm').reset();
            } else {
                alert('Failed to add production log');
            }
        });

        async function fetchProductionData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            let url = '/api/production';
            if (startDate && endDate) {
                url += `?startDate=${startDate}&endDate=${endDate}`;
            }
            const response = await fetch(url, {
                headers: {
                    'Authorization': token
                }
            });
            const data = await response.json();
            const tbody = document.getElementById('productionData');
            tbody.innerHTML = '';
            data.forEach(item => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = new Date(item.createdAt).toLocaleDateString();
                row.insertCell(1).textContent = products.find(p => p.id == item.productId)?.name || 'Unknown';
                row.insertCell(2).textContent = `${item.quantityManufactured} ${products.find(p => p.id == item.productId)?.unit || ''}`;
                row.insertCell(3).textContent = manufacturingUnits.find(u => u.id == item.manufacturedByUnitId)?.name || 'Unknown';
                row.insertCell(4).textContent = item.updationReason || '-';

                const actionsCell = row.insertCell(5);
                const editButton = document.createElement('button');
                editButton.textContent = 'Edit';
                editButton.onclick = () => editLog(item.id, item.quantityManufactured);
                actionsCell.appendChild(editButton);
            });
        }

        function editLog(id, currentQuantity) {
            const newQuantity = prompt('Enter new quantity:', currentQuantity);
            if (newQuantity === null) return; // User cancelled

            const reason = prompt('Enter reason for update:');
            if (reason === null) return; // User cancelled

            updateLog(id, newQuantity, reason);
        }

        async function updateLog(id, quantity, reason) {
            const response = await fetch(`/api/production/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token
                },
                body: JSON.stringify({ quantityManufactured: quantity, updationReason: reason }),
            });

            if (response.ok) {
                fetchProductionData();
            } else {
                alert('Failed to update log');
            }
        }

        document.getElementById('filterButton').addEventListener('click', fetchProductionData);
    </script>
</body>

</html>